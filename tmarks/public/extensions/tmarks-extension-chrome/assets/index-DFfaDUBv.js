import{b as S}from"./prompts-CZcZabTo.js";import{A as c}from"./index-D4dQ38WE.js";class m extends Error{constructor(e,s,o){super(s),this.code=e,this.details=o,this.name="AppError"}}class l{buildPrompt(e,s){const{page:o,context:r,options:a}=e;return console.log("[AI Provider] 已有标签库 ("+r.existingTags.length+"个):",r.existingTags),s?s.replace(/\{title\}/g,o.title).replace(/\{url\}/g,o.url).replace(/\{description\}/g,o.description||"无").replace(/\{content\}/g,o.content?.substring(0,500)||"无").replace(/\{existingTags\}/g,r.existingTags.slice(0,100).join(", ")).replace(/\{recentBookmarks\}/g,r.recentBookmarks.slice(0,10).map(n=>`- ${n.title} [${n.tags.join(", ")}]`).join(`
`)).replace(/\{maxTags\}/g,a.maxTags.toString()).replace(/\{preferExisting\}/g,a.preferExisting?"优先":"可以"):S(e)}handleError(e,s){return e instanceof m?e:e instanceof TypeError||e.name==="NetworkError"?new m("NETWORK_ERROR",`Network error when calling ${s}`,{originalError:e}):e.status===401||e.status===403?new m("API_KEY_INVALID",`Invalid API key for ${s}`,{status:e.status}):e.status===429?new m("RATE_LIMIT_ERROR",`Rate limit exceeded for ${s}`,{status:e.status}):new m("AI_SERVICE_ERROR",`AI service error (${s}): ${e.message||"Unknown error"}`,{originalError:e})}parseResponse(e){try{const s=e.match(/\{[\s\S]*\}/),o=s?s[0]:e,r=JSON.parse(o);if(console.log("[AI Response]",JSON.stringify(r,null,2)),!r.suggestedTags||!Array.isArray(r.suggestedTags))throw new Error("Invalid response format: suggestedTags not found");return{suggestedTags:r.suggestedTags.map(n=>{const i={name:n.name||"",isNew:n.isNew??!0,confidence:n.confidence??.5};return console.log(`[Tag] ${i.name} - isNew: ${i.isNew}`),i}),reasoning:r.reasoning,translatedTitle:r.translatedTitle,translatedDescription:r.translatedDescription}}catch(s){throw console.error("Failed to parse AI response:",e),new m("AI_SERVICE_ERROR","Failed to parse AI response",{content:e,error:s})}}}const x="你是一个智能书签标签推荐助手。优先使用已有标签,只有在必要时才建议新标签。返回格式必须是JSON。",p=t=>{const e=t?.choices?.[0]?.message;if(!e)return;const s=e.content;if(typeof s=="string")return s.trim();if(Array.isArray(s)){const o=s.map(r=>{if(!r)return"";if(typeof r=="string")return r;if(typeof r=="object"){if(typeof r.text=="string")return r.text;if(typeof r.content=="string")return r.content;if(typeof r.value=="string")return r.value;if(r.text&&typeof r.text?.value=="string")return r.text.value}return""}).filter(Boolean).join(`
`).trim();if(o)return o}if(typeof e.text=="string")return e.text.trim();if(typeof t?.output_text=="string")return t.output_text.trim();if(t?.output&&typeof t.output.text=="string")return t.output.text.trim()},O=t=>{const e=t?.content;if(Array.isArray(e)&&e[0]?.type==="text"&&typeof e[0]?.text=="string")return e[0].text.trim();if(typeof t?.output_text=="string")return t.output_text.trim()},y=(t,e)=>{const s=t.trim();if(!s)return e;if(s.includes(e))return s;const o=s.replace(/\/$/,""),r=e.startsWith("/")?e:`/${e}`;return`${o}${r}`},d=(t,e,s)=>{const{apiKey:o,apiUrl:r,model:a,prompt:n,temperature:i,maxTokens:g}=e;let f=r?.trim()||t;f=f.replace(/\/$/,"");const v=y(f,"/chat/completions"),w={"Content-Type":"application/json"};o&&(w.Authorization=`Bearer ${o}`);const h={model:a,messages:[{role:"system",content:x},{role:"user",content:n}],temperature:typeof i=="number"?i:.7,max_tokens:g??s?.defaultMaxTokens??500};return s?.includeJsonResponseFormat&&(h.response_format={type:"json_object"}),s?.additionalBody&&Object.assign(h,s.additionalBody),{url:v,headers:w,body:h,maxTokens:h.max_tokens}},B={openai:{defaultBaseUrl:c.OPENAI,buildRequest:t=>d(c.OPENAI,t,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:p},claude:{defaultBaseUrl:c.CLAUDE,buildRequest:t=>{const e=t.apiUrl?.trim()||c.CLAUDE,s=y(e,"/messages"),o={"Content-Type":"application/json","x-api-key":t.apiKey,"anthropic-version":"2023-06-01"},r={model:t.model,system:x,max_tokens:t.maxTokens??1024,temperature:typeof t.temperature=="number"?t.temperature:.7,messages:[{role:"user",content:[{type:"text",text:t.prompt}]}]};return{url:s,headers:o,body:r,maxTokens:r.max_tokens}},extractContent:O},deepseek:{defaultBaseUrl:c.DEEPSEEK,buildRequest:t=>d(c.DEEPSEEK,t,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:p},zhipu:{defaultBaseUrl:c.ZHIPU,buildRequest:t=>d(c.ZHIPU,t,{defaultMaxTokens:500}),extractContent:p},modelscope:{defaultBaseUrl:c.MODELSCOPE,buildRequest:t=>d(c.MODELSCOPE,t,{defaultMaxTokens:500,additionalBody:{result_format:"message"}}),extractContent:p},siliconflow:{defaultBaseUrl:c.SILICONFLOW,buildRequest:t=>d(c.SILICONFLOW,t,{defaultMaxTokens:500,additionalBody:{stream:!1}}),extractContent:p},iflow:{defaultBaseUrl:c.IFLOW,buildRequest:t=>d(c.IFLOW,t,{defaultMaxTokens:1e3}),extractContent:p},custom:{defaultBaseUrl:c.OPENAI,buildRequest:t=>d(t.apiUrl?.trim()||c.OPENAI,t,{defaultMaxTokens:500}),extractContent:p}};async function u(t){const e=B[t.provider];if(!e)throw new Error(`Unsupported AI provider: ${t.provider}`);const{url:s,headers:o,body:r}=e.buildRequest(t),a=await fetch(s,{method:"POST",headers:o,body:JSON.stringify(r)});if(!a.ok){let g;try{g=await a.text()}catch(f){g=f.message||"Unknown error"}throw new Error(`AI API 请求失败 (${a.status}): ${g.substring(0,200)}`)}const n=await a.json(),i=e.extractContent(n);if(!i)throw new Error(`AI 响应格式错误: ${JSON.stringify(n).substring(0,200)}`);return{content:i,raw:n}}class E extends l{name="openai";models=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];async generateTags(e,s,o="gpt-4o",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"openai",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"OpenAI")}}}class T extends l{name="claude";models=["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"];async generateTags(e,s,o="claude-3-5-sonnet-20241022",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"claude",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:1024,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"Claude")}}}class I extends l{name="deepseek";models=["deepseek-chat","deepseek-reasoner"];async generateTags(e,s,o="deepseek-chat",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"deepseek",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"DeepSeek")}}}class k extends l{name="zhipu";models=["glm-4-plus","glm-4-flash","glm-4-air","glm-4"];async generateTags(e,s,o="glm-4-flash",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"zhipu",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"ZhipuAI")}}}class A extends l{name="modelscope";models=["qwen-plus","qwen-turbo","qwen-max","qwen2.5-72b-instruct"];async generateTags(e,s,o="qwen-turbo",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"modelscope",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"ModelScope")}}}class b extends l{name="siliconflow";models=["deepseek-ai/DeepSeek-V3","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-72B-Instruct","THUDM/glm-4-9b-chat","meta-llama/Meta-Llama-3.1-8B-Instruct"];async generateTags(e,s,o="Qwen/Qwen2.5-7B-Instruct",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"siliconflow",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"SiliconFlow")}}}class R extends l{name="iflow";models=["TBStars2-200B-A13B","TBStars2-70B-A7B"];async generateTags(e,s,o="TBStars2-200B-A13B",r,a){try{const n=this.buildPrompt(e,a),{content:i}=await u({provider:"iflow",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:1e3,temperature:.7});return this.parseResponse(i)}catch(n){throw this.handleError(n,"iFlow")}}}class P extends l{name="custom";models=["custom-model"];async generateTags(e,s,o="gpt-4o",r,a){try{if(!r)throw new Error("自定义 AI 需要配置 API 地址");const n=this.buildPrompt(e,a),{content:i}=await u({provider:"custom",apiKey:s,apiUrl:r,model:o,prompt:n,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(n){throw console.error("[CustomProvider] 错误详情:",n),this.handleError(n,"Custom")}}}const C=new Map([["openai",new E],["claude",new T],["deepseek",new I],["zhipu",new k],["modelscope",new A],["siliconflow",new b],["iflow",new R],["custom",new P]]);function _(t){const e=C.get(t);if(!e)throw new Error(`Unknown AI provider: ${t}`);return e}const $=Object.freeze(Object.defineProperty({__proto__:null,AIProvider:l,ClaudeProvider:T,CustomProvider:P,DeepSeekProvider:I,IFlowProvider:R,ModelScopeProvider:A,OpenAIProvider:E,SiliconFlowProvider:b,ZhipuProvider:k,getAIProvider:_},Symbol.toStringTag,{value:"Module"}));export{m as A,_ as g,$ as i};
